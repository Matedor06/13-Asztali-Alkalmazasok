<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModel="clr-namespace:Solution.DesktopApp.ViewModels"
             xmlns:billModels="clr-namespace:Solution.Services.Services.Bill.Models;assembly=Solution.Services"
             xmlns:billItemModels="clr-namespace:Solution.Services.Services.BillItem.Models;assembly=Solution.Services"
             xmlns:behaviors="clr-namespace:Solution.DesktopApp.Behaviors"
             x:DataType="viewModel:NewBillViewModel"
             x:Class="Solution.DesktopApp.Views.NewBillView"
             Title="√öj Sz√°mla">

    <Grid Padding="20" ColumnDefinitions="1*,1.5*" ColumnSpacing="20">
        
        <!-- BAL OLDAL - Sz√°mla adatok √©s T√©tel hozz√°ad√°sa -->
        <ScrollView Grid.Column="0">
            <VerticalStackLayout Spacing="15">
                
                <!-- Sz√°mla adatok -->
                <Border Padding="15" StrokeThickness="1" Stroke="Gray" BackgroundColor="#1a1a1a">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="8"/>
                    </Border.StrokeShape>
                    
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Sz√°mla adatok" FontSize="20" FontAttributes="Bold" TextColor="White"/>
                        
                        <Label Text="Sz√°mla sz√°ma *" TextColor="LightGray"/>
                        <Entry Text="{Binding CurrentBill.BillNumber}" 
                               Placeholder="Pl: SZLA-2025-001"
                               TextColor="White"
                               PlaceholderColor="Gray"
                               BackgroundColor="#2a2a2a"/>
                        
                        <Label Text="Sz√°mla kelte *" TextColor="LightGray"/>
                        <DatePicker Date="{Binding CurrentBill.DateIssued}"
                                    TextColor="White"
                                    BackgroundColor="#2a2a2a"/>
                    </VerticalStackLayout>
                </Border>

                <!-- T√©tel hozz√°ad√°sa -->
                <Border Padding="15" StrokeThickness="1" Stroke="Gray" BackgroundColor="#1a1a1a">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="8"/>
                    </Border.StrokeShape>
                    
                    <VerticalStackLayout Spacing="10">
                        <Label FontSize="20" FontAttributes="Bold" TextColor="White">
                            <Label.Text>
                                <Binding Path="IsItemEditMode">
                                    <Binding.Converter>
                                        <StaticResource Key="BoolToTextConverter"/>
                                    </Binding.Converter>
                                    <Binding.ConverterParameter>
                                        <x:String>T√©tel szerkeszt√©se|T√©tel hozz√°ad√°sa</x:String>
                                    </Binding.ConverterParameter>
                                </Binding>
                            </Label.Text>
                        </Label>
                        
                        <Label Text="T√©tel neve *" TextColor="LightGray"/>
                        <Entry Text="{Binding CurrentBillItem.Name}" 
                               Placeholder="Pl: Laptop"
                               TextColor="White"
                               PlaceholderColor="Gray"
                               BackgroundColor="#2a2a2a"/>
                        
                        <Label Text="Egys√©g√°r (Ft) *" TextColor="LightGray"/>
                        <Entry Text="{Binding CurrentBillItem.UnitPrice}" 
                               Placeholder="Minimum 1"
                               Keyboard="Numeric"
                               TextColor="White"
                               PlaceholderColor="Gray"
                               BackgroundColor="#2a2a2a">
                            <Entry.Behaviors>
                                <behaviors:EntryIntegerBehavior/>
                            </Entry.Behaviors>
                        </Entry>
                        
                        <Label Text="Mennyis√©g *" TextColor="LightGray"/>
                        <Entry Text="{Binding CurrentBillItem.Quantity}" 
                               Placeholder="Minimum 1"
                               Keyboard="Numeric"
                               TextColor="White"
                               PlaceholderColor="Gray"
                               BackgroundColor="#2a2a2a">
                            <Entry.Behaviors>
                                <behaviors:EntryIntegerBehavior/>
                            </Entry.Behaviors>
                        </Entry>
                        
                        <HorizontalStackLayout Spacing="10" Margin="0,10,0,0">
                            <Button BackgroundColor="#007acc"
                                    TextColor="White"
                                    Command="{Binding AddOrUpdateBillItemCommand}"
                                    HorizontalOptions="FillAndExpand">
                                <Button.Text>
                                    <Binding Path="IsItemEditMode">
                                        <Binding.Converter>
                                            <StaticResource Key="BoolToTextConverter"/>
                                        </Binding.Converter>
                                        <Binding.ConverterParameter>
                                            <x:String>M√≥dos√≠t√°s|Hozz√°ad√°s</x:String>
                                        </Binding.ConverterParameter>
                                    </Binding>
                                </Button.Text>
                            </Button>
                            
                            <Button Text="M√©gse"
                                    Command="{Binding CancelItemEditCommand}"
                                    IsVisible="{Binding IsItemEditMode}"
                                    BackgroundColor="#6c757d"
                                    TextColor="White"
                                    HorizontalOptions="FillAndExpand"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- M≈±veletek -->
                <VerticalStackLayout Spacing="10">
                    <Button Text="Sz√°mla adatainak ment√©se"
                            Command="{Binding SaveBillCommand}"
                            IsEnabled="{Binding CanSaveBill}"
                            BackgroundColor="#28a745"
                            TextColor="White"
                            Padding="0,15"
                            FontSize="16"
                            FontAttributes="Bold"/>
                    
                    <Button Text="M√©gse / √öj sz√°mla"
                            Command="{Binding ResetFormCommand}"
                            BackgroundColor="#6c757d"
                            TextColor="White"
                            Padding="0,15"/>
                </VerticalStackLayout>
                
            </VerticalStackLayout>
        </ScrollView>

        <!-- JOBB OLDAL - Sz√°mla t√©telei lista -->
        <Border Grid.Column="1" 
                Padding="15" 
                StrokeThickness="1" 
                Stroke="Gray" 
                BackgroundColor="#1a1a1a">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="8"/>
            </Border.StrokeShape>
            
            <Grid RowDefinitions="Auto,*,Auto">
                
                <!-- Fejl√©c -->
                <Label Grid.Row="0" 
                       Text="Sz√°mla t√©telei" 
                       FontSize="20" 
                       FontAttributes="Bold" 
                       TextColor="White"
                       Margin="0,0,0,10"/>
                
                <!-- T√©telek list√°ja -->
                <ScrollView Grid.Row="1">
                    <CollectionView ItemsSource="{Binding BillItems}">
                        <CollectionView.EmptyView>
                            <VerticalStackLayout VerticalOptions="Center" 
                                               HorizontalOptions="Center" 
                                               Spacing="15"
                                               Margin="0,50">
                                <Label Text="üìã" 
                                       FontSize="50" 
                                       HorizontalOptions="Center"
                                       TextColor="Gray"/>
                                <Label Text="M√©g nincs t√©tel hozz√°adva" 
                                       TextColor="Gray" 
                                       FontSize="16"
                                       HorizontalOptions="Center"/>
                                <Label Text="Adjon hozz√° t√©teleket a bal oldali ≈±rlapon" 
                                       TextColor="DarkGray" 
                                       FontSize="12"
                                       HorizontalOptions="Center"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                        
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="billItemModels:BillItemModel">
                                <Border Padding="12" 
                                        Margin="0,5" 
                                        StrokeThickness="1" 
                                        Stroke="#444" 
                                        BackgroundColor="#2a2a2a">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="5"/>
                                    </Border.StrokeShape>
                                    
                                    <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto,Auto" RowSpacing="5">
                                        
                                        <!-- T√©tel neve -->
                                        <Label Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3"
                                               Text="{Binding Name}" 
                                               FontSize="16" 
                                               FontAttributes="Bold" 
                                               TextColor="White"/>
                                        
                                        <!-- √Årinf√≥ -->
                                        <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3"
                                               TextColor="LightGray">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding UnitPrice, StringFormat='{0:N0} Ft'}"/>
                                                    <Span Text=" √ó "/>
                                                    <Span Text="{Binding Quantity, StringFormat='{0} db'}"/>
                                                    <Span Text=" = "/>
                                                    <Span Text="{Binding TotalPrice, StringFormat='{0:N0} Ft'}" 
                                                          FontAttributes="Bold"
                                                          TextColor="White"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                        
                                        <!-- Gombok -->
                                        <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3" 
                                                             Spacing="5" 
                                                             Margin="0,5,0,0">
                                            <Button Text="‚úèÔ∏è Szerkeszt√©s" 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewModel:NewBillViewModel}}, Path=EditBillItemCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#ffc107"
                                                    TextColor="Black"
                                                    Padding="10,5"
                                                    FontSize="12"
                                                    HorizontalOptions="FillAndExpand"/>
                                            
                                            <Button Text="üóëÔ∏è T√∂rl√©s" 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewModel:NewBillViewModel}}, Path=DeleteBillItemCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="#dc3545"
                                                    TextColor="White"
                                                    Padding="10,5"
                                                    FontSize="12"
                                                    HorizontalOptions="FillAndExpand"/>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </ScrollView>
                
                <!-- √ñsszes√≠t≈ë -->
                <Border Grid.Row="2" 
                        Padding="15" 
                        Margin="0,10,0,0"
                        BackgroundColor="#007acc"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="5"/>
                    </Border.StrokeShape>
                    
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               Text="V√©g√∂sszeg:" 
                               FontSize="18" 
                               FontAttributes="Bold" 
                               TextColor="White"
                               VerticalOptions="Center"/>
                        
                        <Label Grid.Column="1" 
                               FontSize="22" 
                               FontAttributes="Bold" 
                               TextColor="White"
                               VerticalOptions="Center">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span>
                                        <Span.Text>
                                            <Binding Path="BillItems" StringFormat="{}{0:N0} Ft">
                                                <Binding.Converter>
                                                    <StaticResource Key="TotalPriceConverter"/>
                                                </Binding.Converter>
                                            </Binding>
                                        </Span.Text>
                                    </Span>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </Grid>
                </Border>
                
            </Grid>
        </Border>

    </Grid>

</ContentPage>
