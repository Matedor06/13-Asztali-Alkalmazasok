using ConsoleApp1;
using System.Text;

var fileData = await File.ReadAllLinesAsync("autok.txt", Encoding.UTF8);
var lend = new List<Lend>();
foreach(var line in fileData)
{
    var data = line.Split(' ');
    lend.Add(new Lend
    {
        day = int.Parse(data[0]),
        dayTime = data[1],
        registrationNumber = data[2],
        employeeNumber = int.Parse(data[3]),
        kmCounter = int.Parse(data[4]),
        inOut = int.Parse(data[5]),
    });
}
var lastLend = lend.MaxBy(x => x.day);
Console.WriteLine($"{lastLend.day}. nap rendszám : {lastLend.registrationNumber}");
Console.WriteLine("szia");

Console.Write("Nap: ");
int day = int.Parse(Console.ReadLine());
var specificDay = lend.Where(x => x.day == day);
foreach (var item in specificDay)
{
    Console.Write($"{item.dayTime} {item.registrationNumber} {item.employeeNumber} ");
    if (item.inOut == 0)
    {
        Console.Write("ki");
    }
    else
    {
        Console.WriteLine("be");
    }
    Console.WriteLine();
}

var countNotBroughtBackCars = lend
    .GroupBy(x => x.registrationNumber)
    .Where(g => g.OrderByDescending(x => x.day).ThenByDescending(x => x.dayTime).First().inOut == 0)
    .Count();
Console.WriteLine($"A hónap végén {countNotBroughtBackCars} autó nem volt bent a parkolóban.");

var countKmforallCars = lend
    .GroupBy(x => x.registrationNumber)
    .Select(g =>
    {
        var orderedRecords = g.OrderBy(x => x.day).ThenBy(x => x.dayTime).ToList();
        int totalKm = 0;
        
        for (int i = 1; i < orderedRecords.Count; i++)
        {
            if (orderedRecords[i].inOut == 1) // When car comes back IN
            {
                totalKm += orderedRecords[i].kmCounter - orderedRecords[i - 1].kmCounter;
            }
        }
        
        // If car is still out, calculate from last OUT to last recorded km
        var lastRecord = orderedRecords.Last();
        if (lastRecord.inOut == 0)
        {
            var lastOutRecord = orderedRecords.Last(r => r.inOut == 0);
            var previousRecord = orderedRecords[orderedRecords.IndexOf(lastOutRecord) - 1];
            totalKm += lastOutRecord.kmCounter - previousRecord.kmCounter;
        }
        
        return new { RegistrationNumber = g.Key, TotalKm = totalKm };
    });

Console.WriteLine("\nStatisztika - Megtett távolság autónként:");
foreach (var car in countKmforallCars)
{
    Console.WriteLine($"{car.RegistrationNumber}: {car.TotalKm} km");
}