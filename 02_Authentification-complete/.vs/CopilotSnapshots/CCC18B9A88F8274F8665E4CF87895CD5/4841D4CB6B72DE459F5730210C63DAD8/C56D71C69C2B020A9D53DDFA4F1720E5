var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllers();
builder.LoadEnviorementVariables()
       .ConfigureDI()
       .LoadSettings()
       .ConfigureDatabase()
       .UseIdentity()
       .UseSecurity()
       .AddGlobalErrorHandling()
       .UseScalarOpenAPI();



var app = builder.Build();

// Initialize database (ensure migrations are applied)
using (var scope = app.Services.CreateScope())
{
    try
    {
        var dbContext = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
        await dbContext.Database.MigrateAsync();
    }
    catch (Exception ex)
    {
        var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();
        logger.LogError(ex, "An error occurred while migrating the database. Make sure SQL Server is running and the connection string is correct.");
        throw;
    }
}

app.AddGlobalErrorHandling();
app.UseHttpsRedirection();
app.UseRouting();
app.UseSecurity();
app.MapControllers();
app.UseScalarOpenAPI();

await app.RunAsync();
